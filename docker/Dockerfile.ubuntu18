# Dockerfile.ubuntu18
# -----------------------------------------------------------------------------
# Purpose: Tests whether the compiled radar-collector binary can run on Ubuntu 18.04.
# This simulates a minimal, older glibc-based Linux runtime environment.
# Build manually using a recent toolchain, then copy the radar-collector binary into this image.
#
# Usage:
#   docker build -f Dockerfile.ubuntu18 -t radar-collector-ubuntu18 .
#   docker run --rm radar-collector-ubuntu18

# ---- Build Stage ----
FROM ubuntu:18.04 AS builder

# Install Rust and dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    curl \
    unzip \
    build-essential \
    pkg-config \
    libssl-dev \
    ca-certificates && \
    curl https://sh.rustup.rs -sSf | bash -s -- -y && \
    rm -rf /var/lib/apt/lists/*

RUN curl -L -o protoc.zip https://github.com/protocolbuffers/protobuf/releases/download/v31.1/protoc-31.1-linux-x86_64.zip && \
    unzip protoc.zip -d /usr/local && \
    rm protoc.zip

ENV PATH="/root/.cargo/bin:${PATH}"
ENV CARGO_HOME=/cargo
WORKDIR /app

COPY proto ./proto
COPY collector ./collector

WORKDIR /app/collector
RUN cargo build --release

# ---- Runtime Stage ----
FROM ubuntu:18.04

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    libssl1.1 \
    ca-certificates \
    curl && \
    rm -rf /var/lib/apt/lists/* && \
    adduser --disabled-password --gecos "" appuser

COPY --from=builder /app/collector/target/release/radar-collector /usr/local/bin/radar-collector

ENV COLLECTOR_TLS_CERT=/certs/server.pem
ENV COLLECTOR_TLS_KEY=/certs/server.key

# Healthcheck for orchestrators
HEALTHCHECK --interval=30s --timeout=5s \
  CMD ["/usr/local/bin/radar-collector", "--health"] || exit 1

USER appuser

ENTRYPOINT ["/usr/local/bin/radar-collector"]
